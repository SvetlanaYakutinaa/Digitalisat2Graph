<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Personennetzwerk mit Filter</title>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    #mynetwork {
      width: 100%;
      height: 600px;
      border: 1px solid lightgray;
    }

    body {
      font-family: sans-serif;
      padding: 20px;
    }

    #controls {
      margin-bottom: 20px;
    }

    select {
      padding: 5px;
      font-size: 14px;
    }

    #details {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>Personen-Beziehungsnetz mit Filter</h1>

  <div id="controls">
    <label>
      Filter nach Beziehung:
      <select id="relationFilter">
        <option value="">Alle Beziehungen</option>
        <option value="Mutter">Mutter</option>
        <option value="Ehepartner(in)">Ehepartner(in)</option>
      </select>
    </label>
  </div>

  <div id="mynetwork"></div>
  <div id="details">
    <strong>Klicke auf einen Knoten, um Details anzuzeigen</strong>
  </div>

  <script>
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, function (match) {
        const escapeMap = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return escapeMap[match];
      });
    }

    const rawData = [
      {
        text: "Nachdem derselbe in Ebersdorf mit der ledigen schwester Rosalie Bauer verbunden worden und diese unsere‚ geliebten Kinder sich noch einige Zeit bei uns aufhalten, sah ih dieselben mit dankbar gebeugtem Nrzen ihrem hohen Berufe entgegen gehen.",
        subjekt: "Agnes Lemmerz",
        q_subjekt: "Q104219675",
        subjekt_type: "person",
        subjekt_ref: "https://www.wikidata.org/wiki/Q104219675",
        objekt: "Johannes Friedrich Lemmerz",
        q_objekt: "Q123420358",
        objekt_type: "person",
        objekt_ref: "https://www.wikidata.org/wiki/Q123420358",
        prädikat: "Mutter",
        zeit: "",
        ref: "https://collections.mun.ca/digital/collection/nachrichten/id/68219/rec/191",
        nbg: "NBG 1856"
      },
      {
        text: "Am 3 März desselben Jahres wurde mir der Antrag gemacht, mit der ledigen schwester Agnes Jenke in den stand der heiligen Ehe zu treten, und da der Heiland mir Freudigkeit schenkte, diese schwester aus seiner Hand zu meiner künftigen Lebensgefährtin anzunehmen, so wurden wir am 26 März getraut.",
        subjekt: "Agnes Lemmerz",
        q_subjekt: "Q115005136",
        subjekt_type: "person",
        subjekt_ref: "https://www.wikidata.org/wiki/Q115005136",
        objekt: "Johannes Friedrich Lemmerz",
        q_objekt: "Q123420358",
        objekt_type: "person",
        objekt_ref: "https://www.wikidata.org/wiki/Q123420358",
        prädikat: "Ehepartner(in)",
        zeit: "26.03.",
        ref: "https://collections.mun.ca/digital/collection/nachrichten/id/68219/rec/191",
        nbg: "NBG 1856"
      }
    ];

    const nodesMap = new Map();
    const edgeData = [];

    rawData.forEach(entry => {
      const subjId = entry.q_subjekt || entry.subjekt;
      const objId = entry.q_objekt || entry.objekt;
      const timeId = `zeit-${entry.zeit}`;

      if (!nodesMap.has(subjId)) {
        nodesMap.set(subjId, {
          id: subjId,
          label: entry.subjekt,
          title: entry.subjekt,
          link: entry.subjekt_ref
        });
      }
      if (entry.objekt && !nodesMap.has(objId)) {
        nodesMap.set(objId, {
          id: objId,
          label: entry.objekt,
          title: entry.objekt,
          link: entry.objekt_ref
        });
      }

      if (entry.zeit && !nodesMap.has(timeId)) {
        nodesMap.set(timeId, {
          id: timeId,
          label: entry.zeit,
          shape: "box",
          color: "#fdd835"
        });
      }

      if (entry.objekt && entry.prädikat) {
        edgeData.push({
          from: subjId,
          to: objId,
          label: entry.prädikat,
          arrows: "to",
          relation: entry.prädikat,
          color: { color: "#2c3e50" }
        });
      }

      if (entry.zeit) {
        edgeData.push({
          from: subjId,
          to: timeId,
          dashes: true,
          color: { color: "#888" },
          label: "Zeit"
        });
      }
    });

    const allNodes = new vis.DataSet(Array.from(nodesMap.values()));
    const allEdges = new vis.DataSet(edgeData);

    const nodesView = new vis.DataView(allNodes);
    let relationFilterValue = "";

    const edgeFilter = (edge) => {
      if (relationFilterValue === "") return true;
      return edge.relation === relationFilterValue;
    };

    const edgesView = new vis.DataView(allEdges, { filter: edgeFilter });

    const container = document.getElementById("mynetwork");
    const network = new vis.Network(container, {
      nodes: nodesView,
      edges: edgesView
    }, {
      edges: { smooth: true, font: { align: "middle" } },
      nodes: { shape: "dot", size: 20 },
      physics: { stabilization: true }
    });

    document.getElementById("relationFilter").addEventListener("change", e => {
      relationFilterValue = e.target.value;
      edgesView.refresh();
    });

    const details = document.getElementById("details");

    network.on("click", function (params) {
      if (params.nodes.length > 0) {
        const nodeId = params.nodes[0];
        const node = allNodes.get(nodeId);
        const related = rawData.filter(entry =>
          entry.q_subjekt === nodeId || entry.q_objekt === nodeId
        );

        if (related.length === 0) {
          details.innerHTML = `<p>Keine Informationen gefunden.</p>`;
          return;
        }

        let html = `<h3>Details zu: ${node.label}</h3><hr>`;
        related.forEach(entry => {
          html += `
            <div class="detail-block">
              <strong>Quelle:</strong><br>
              <a href="${entry.ref}" target="_blank">${entry.nbg || "Quelle"}</a><br><br>
              ${escapeHTML(entry.text)}<br><br>
              <strong>Personen:</strong><br>
              <a href="${entry.subjekt_ref}" target="_blank">${entry.subjekt}</a><br>
              ${entry.objekt ? `<a href="${entry.objekt_ref}" target="_blank">${entry.objekt}</a><br>` : ""}
            </div><hr>
          `;
        });

        details.innerHTML = html;
      }
    });
  </script>
</body>
</html>
